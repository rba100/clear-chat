<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="site.css">
    <script src="scripts/jquery-3.3.1.js"></script>
    <script src="scripts/md5.js"></script>
    <script src="scripts/showdown.js"></script>
    <script src="scripts/signalr.min.js"></script>
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-text">
                <span id="client-count"></span>
            </div>
            <div class="navbar-text"><a class="nav navbar-nav" href="changeIdentity">change identity</a></div>
        </div>
    </div>
    <div class="container" id="main-content">
        <div id="output-container" class="row">
            <div id="history"></div>
        </div>
        <div id="input-container" class="row">
            <div id="input-form">
                <div class="col-xs-12">
                    <input type="text" id="text-input" class="form-control" />
                </div>
                <div class="col-xs-1" style="display: none;">
                    <button class="btn btn-primary" id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var maxHistory = 400;
        var chatHistory = $('#history');
        var outputContainer = $('#output-container');
        var converter = new showdown.Converter();

        var lastAuthor = "";


        connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        var unreadMessages = 0;
        var focused = true;

        window.onfocus = function () {
            focused = true;
            unreadMessages = 0;
            window.document.title = "Clear Chat";
        };
        window.onblur = function () {
            focused = false;
        };

        connection.onclose(function (error) {
            console.log("DEBUG: connection closed.");
            if (error) console.log("DEBUG: " + error);
        });

        connection.on("newMessage",
            function (chatItem) {
                insertChatItem(chatItem);
                if (!focused) {
                    unreadMessages++;
                    window.document.title = "Clear Chat (" + unreadMessages + ")";
                }
            });

        connection.on("initHistory",
            function (historyItems) {
                chatHistory.empty();
                lastAuthor = "";
                for (var i = 0; i < historyItems.length; i++) {
                    insertChatItem(historyItems[i]);
                }
            });

        connection.on("initClients",
            function (clients) {
                var plural = clients.length == 1 ? "" : "s";
                $('#client-count').html(clients.length + " user" + plural);
            });

        connection.start().then(function () {
            $('#send-button').click(send);
            $('#text-input').keypress(function (e) {
                if (e.which === 13) {
                    send();
                }
            });
            $('#text-input').focus();
            loadHistory();
        });

        function send() {
            var message = $('#text-input').val();
            connection.send("send", message).catch(function (error) {
                console.log(error);
            });
            $('#text-input').val("");
        }

        function loadHistory() {
            connection.send("getHistory");
        }

        function insertChatItem(chatItem) {
            var safeMessage = chatItem.message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            var processedMessage = converter.makeHtml(safeMessage);
            var row = $('<div class="chat-item">' +
                '<p>' +
                processedMessage +
                '</p>' +
                '</div>');
            if (lastAuthor !== chatItem.userId) {
                var nameElement = $('<span title="' +
                    chatItem.timeStampUtc +
                    '">' +
                    '<b>' +
                    chatItem.userId +
                    '</b></span><br class="hide-for-wide" />' +
                    '<span class="hide-for-small"> : </span>');
                //nameElement.find('b').css("color", randomColor(chatItem.userId));
                nameElement.find('b').css("color", '#' + chatItem.colour);
                row.prepend(nameElement);
                //row.prepend(getProfilePicElement(chatItem.Name));
            }
            lastAuthor = chatItem.userId;
            chatHistory.append(row);
            scrollToBottom();
        }

        function scrollToBottom() {
            outputContainer.scrollTop(2000000000);
        }

        function getProfilePicElement(emailAddress) {
            var hash = md5(emailAddress.trim().toLowerCase());
            var element = $('<img class="profile-picture" src="https://www.gravatar.com/avatar/' +
                hash +
                '?d=retro&s=32" width="32" height="32"/>');
            return element;
        }

        var crc32 = (function () {
            var table = new Uint32Array(256);

            // Pre-generate crc32 polynomial lookup table
            // http://wiki.osdev.org/CRC32#Building_the_Lookup_Table
            // ... Actually use Alex's because it generates the correct bit order
            //     so no need for the reversal function
            for (var i = 256; i--;) {
                var tmp = i;

                for (var k = 8; k--;) {
                    tmp = tmp & 1 ? 3988292384 ^ tmp >>> 1 : tmp >>> 1;
                }

                table[i] = tmp;
            }

            // crc32b
            // Example input        : [97, 98, 99, 100, 101] (Uint8Array)
            // Example output       : 2240272485 (Uint32)
            return function (data) {
                var crc = -1; // Begin with all bits set ( 0xffffffff )

                for (var i = 0, l = data.length; i < l; i++) {
                    crc = crc >>> 8 ^ table[crc & 255 ^ data[i]];
                }

                return (crc ^ -1) >>> 0; // Apply binary NOT
            };

        })();
    </script>
</body>
</html>